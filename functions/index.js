const { onCall, HttpsError } = require("firebase-functions/v2/https");
const admin = require("firebase-admin");
const { OpenAI } = require("openai");

admin.initializeApp();
const db = admin.firestore();

exports.chatWithAI = onCall({ 
    region: "us-central1",
    secrets: ["OPENAI_API_KEY"] // üëà –ö–∞–∑–≤–∞–º–µ –Ω–∞ Firebase –¥–∞ –∑–∞—Ä–µ–¥–∏ –∫–ª—é—á–∞ –æ—Ç Secret Manager
}, async (request) => {
    // 0. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ OpenAI —Å—ä—Å —Å–∏–≥—É—Ä–Ω–∏—è –∫–ª—é—á
    const openai = new OpenAI({
        apiKey: process.env.OPENAI_API_KEY, 
    });

    const { message, history, context: tourContext } = request.data;

    try {
        // 1. –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∫–æ–º–ø–∞–Ω–∏—è—Ç–∞ –æ—Ç Firestore
        const companySnap = await db.doc("settings/company").get();
        const companyInfo = companySnap.exists 
            ? companySnap.data().info 
            : "Beliva VIP Tour –µ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞ –∞–≥–µ–Ω—Ü–∏—è –∑–∞ –µ–∫–∑–æ—Ç–∏—á–Ω–∏ –ø—ä—Ç–µ—à–µ—Å—Ç–≤–∏—è.";

        // 2. –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –∞–∫—Ç–∏–≤–Ω–∏ –µ–∫—Å–∫—É—Ä–∑–∏–∏ (–ö–∞—Ç–∞–ª–æ–≥)
        const toursSnap = await db.collection("tours").where("status", "==", "public").get();
        const toursList = toursSnap.docs.map(doc => {
            const t = doc.data();
            // –í–∑–∏–º–∞–º–µ —Å–∞–º–æ –Ω–∞–π-–≤–∞–∂–Ω–æ—Ç–æ, –∑–∞ –¥–∞ –ø–µ—Å—Ç–∏–º —Ç–æ–∫–µ–Ω–∏
            return `- ${t.title} (${t.country}): –¶–µ–Ω–∞ ${t.price}, –î–∞—Ç–∏: ${t.date || '–ü–æ –∑–∞–ø–∏—Ç–≤–∞–Ω–µ'}`;
        }).join("\n");

        // 3. –ö–æ–Ω—Å—Ç—Ä—É–∏—Ä–∞–Ω–µ –Ω–∞ –°–∏—Å—Ç–µ–º–Ω–∏—è –ü—Ä–æ–º–ø—Ç
        const systemPrompt = `
–¢–∏ —Å–∏ Beliva VIP Assistant ‚Äì –µ–∫—Å–ø–µ—Ä—Ç –ø–æ –ª—É–∫—Å–æ–∑–Ω–∏ –ø—ä—Ç–µ—à–µ—Å—Ç–≤–∏—è.

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –ó–ê –ö–û–ú–ü–ê–ù–ò–Ø–¢–ê:
${companyInfo}

–ù–ê–®–ò–Ø–¢ –ö–ê–¢–ê–õ–û–ì –° –ï–ö–°–ö–£–†–ó–ò–ò:
${toursList}

${tourContext ? `–í–ê–ñ–ù–û: –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç —Ä–∞–∑–≥–ª–µ–∂–¥–∞ –≤ –º–æ–º–µ–Ω—Ç–∞: "${tourContext.title}".` : "–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –µ –Ω–∞ –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–ª–∏ —Ä–∞–∑–≥–ª–µ–∂–¥–∞ –æ–±—â–∏—è —Å–ø–∏—Å—ä–∫."}

–ò–ù–°–¢–†–£–ö–¶–ò–ò –ó–ê –ü–û–í–ï–î–ï–ù–ò–ï:
1. –û—Ç–≥–æ–≤–∞—Ä—è–π –≤–∏–Ω–∞–≥–∏ –Ω–∞ –ë–™–õ–ì–ê–†–°–ö–ò –µ–∑–∏–∫. –¢–æ–Ω—ä—Ç —Ç–∏ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ª—é–±–µ–∑–µ–Ω, –∏–Ω—Ç—Ä–∏–≥—É–≤–∞—â –∏ –≤–¥—ä—Ö–Ω–æ–≤—è–≤–∞—â.
2. –ò–∑–ø–æ–ª–∑–≤–∞–π Markdown: **bold** –∑–∞ –∞–∫—Ü–µ–Ω—Ç–∏ –∏ —Å–ø–∏—Å—ä—Ü–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥–Ω–æ—Å—Ç.
3. –ö–æ–≥–∞—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞—à –¥–µ—Å—Ç–∏–Ω–∞—Ü–∏—è, —Å–ø–æ–º–µ–Ω–∞–≤–∞–π —Ü–µ–Ω–∞—Ç–∞ –∏ –∑–∞—â–æ –µ —Å–ø–µ—Ü–∏–∞–ª–Ω–∞.
4. –ê–∫–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç —Å–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–≤–∞ –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –æ—Ñ–µ—Ä—Ç–∞, –¥–∞–π –º—É –¥–µ—Ç–∞–π–ª–∏ –∑–∞ –Ω–µ—è.
5. –ó–∞–≤—ä—Ä—à–≤–∞–π —Å –ø–æ–∫–∞–Ω–∞ –∑–∞ –≤—Ä—ä–∑–∫–∞ (Email/WhatsApp), –∞–∫–æ —É—Å–µ—Ç–∏—à, —á–µ –∫–ª–∏–µ–Ω—Ç—ä—Ç –µ –≥–æ—Ç–æ–≤ –∑–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è.
6. –ê–∫–æ —É—Å–µ—Ç–∏—à, —á–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –∏—Å–∫–∞ –¥–∞ —Å–ª–µ–¥–∏ –æ—Ñ–µ—Ä—Ç–∏—Ç–µ –Ω–∏ –¥—ä–ª–≥–æ—Å—Ä–æ—á–Ω–æ, –ø—Ä–µ–¥–ª–æ–∂–∏ –º—É –¥–∞ —Å–µ –∑–∞–ø–∏—à–µ –∑–∞ –Ω–∞—à–∏—è "VIP –ë—é–ª–µ—Ç–∏–Ω" –≤ –Ω–∞–π-–¥–æ–ª–Ω–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.
`;

        // 4. –ò–∑–ø—Ä–∞—â–∞–Ω–µ –∫—ä–º OpenAI
        const completion = await openai.chat.completions.create({
            model: "gpt-4o-mini", 
            messages: [
                { role: "system", content: systemPrompt },
                ...(history || []),
                { role: "user", content: message }
            ],
            temperature: 0.7,
            max_tokens: 500 // –û–≥—Ä–∞–Ω–∏—á–∞–≤–∞–º–µ –¥—ä–ª–∂–∏–Ω–∞—Ç–∞ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞ –∑–∞ –ø–æ-–¥–æ–±—ä—Ä UX
        });

        return {
            reply: completion.choices[0].message.content
        };

    } catch (error) {
        console.error("AI Error:", error);
        throw new HttpsError("internal", "–ò–∑–≤–∏–Ω–µ—Ç–µ, –∞—Å–∏—Å—Ç–µ–Ω—Ç—ä—Ç –∏–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞ —Ç—Ä—É–¥–Ω–æ—Å—Ç.");
    }
});